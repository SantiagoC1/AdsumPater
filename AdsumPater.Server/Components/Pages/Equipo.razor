@page "/equipo"
@using AdsumPater.Core.Entities
@using AdsumPater.Core.Enums
@using AdsumPater.Core.Interfaces
@inject IEquipoService EquipoService

<section class="page-head">
    <div class="container-xl">
        <h1>Equipo de MisiÃ³n</h1>
        <p class="muted">
            ConocÃ© a quienes organizan y sostienen la misiÃ³n.
        </p>
    </div>
</section>

<section class="team-wrap">
    <div class="container-xl">

        @if (cargando)
        {
            <p class="muted">Cargando equipo...</p>
        }
        else if (miembros.Count == 0)
        {
            <p class="muted">TodavÃ­a no hay miembros cargados.</p>
        }
        else
        {
            <div class="team-grid">
                @foreach (var group in grupos)
                {
                    <article class="group-card">
                        <header class="group-head">
                            <div class="group-title">
                                <h2>@group.Area</h2>
                                <span class="count">@group.Miembros.Count</span>
                            </div>
                            <p class="group-sub">@group.Descripcion</p>
                        </header>

                        <div class="members">
                            @foreach (var m in group.Miembros)
                            {
                                <div class="member-card">
                                    <div class="avatar" aria-hidden="true">
                                        @Initials(m.Nombre, m.Apellido)
                                    </div>

                                    <div class="member-body">
                                        <div class="member-top">
                                            <div class="member-name">
                                                <strong>@m.Nombre @m.Apellido</strong>
                                                @if (!string.IsNullOrWhiteSpace(m.Apodo))
                                                {
                                                    <span class="nick">(@m.Apodo)</span>
                                                }
                                            </div>

                                            <span class="pill">@RolLabel(m.Rol)</span>
                                        </div>

                                        <div class="member-meta">
                                            <span class="meta-item">ðŸŽ‚ @m.Edad aÃ±os</span>
                                            <span class="meta-sep">â€¢</span>
                                            <span class="meta-item">ðŸŽ“ @m.CarreraOProfesion</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </article>
                }
            </div>
        }

    </div>
</section>

@code {
    private bool cargando = true;
    private List<TeamMember> miembros = new();
    private List<GroupVM> grupos = new();

    protected override async Task OnInitializedAsync()
    {
        miembros = await EquipoService.ObtenerEquipoAsync();

        // Agrupamos por RolEquipo
        var porRol = miembros
            .GroupBy(m => m.Rol)
            .ToDictionary(g => g.Key, g => g.ToList());

        // Armamos la vista en el orden que te importa
        grupos = new List<GroupVM>
        {
            NewGroup(RolEquipo.Rector, "Rectores", "Coordinan y guÃ­an la misiÃ³n (jefes del aÃ±o).", porRol),
            NewGroup(RolEquipo.PenaYComunicacion, "PeÃ±a y ComunicaciÃ³n", "AnimaciÃ³n, logÃ­stica y difusiÃ³n de la misiÃ³n.", porRol),
            NewGroup(RolEquipo.Infraestructura, "Infraestructura", "Materiales, recursos, armado y soporte general.", porRol),
            NewGroup(RolEquipo.ViaCrucis, "VÃ­a Crucis", "PlanificaciÃ³n y coordinaciÃ³n del VÃ­a Crucis.", porRol),
            NewGroup(RolEquipo.Espiritualidad, "Espiritualidad", "OraciÃ³n, momentos espirituales y acompaÃ±amiento.", porRol),
            NewGroup(RolEquipo.Coro, "Coro", "Cantos, ensayos y animaciÃ³n musical.", porRol),
            NewGroup(RolEquipo.Apostolado, "Apostolado", "Visitas, actividades y misiÃ³n en el pueblo.", porRol),

            // Si tenÃ©s Asesor/Asesora
            NewGroup(RolEquipo.Asesor, "Asesores", "AcompaÃ±amiento y guÃ­a.", porRol),
            NewGroup(RolEquipo.Asesora, "Asesoras", "AcompaÃ±amiento y guÃ­a.", porRol),
        }
        .Where(g => g.Miembros.Count > 0) // no mostrar grupos vacÃ­os
        .ToList();

        cargando = false;
    }

    private static GroupVM NewGroup(RolEquipo rol, string area, string desc, Dictionary<RolEquipo, List<TeamMember>> porRol)
        => new(area, desc, porRol.TryGetValue(rol, out var list) ? list : new List<TeamMember>());

    private static string Initials(string nombre, string apellido)
    {
        var a = string.IsNullOrWhiteSpace(nombre) ? "?" : nombre.Trim()[0].ToString().ToUpper();
        var b = string.IsNullOrWhiteSpace(apellido) ? "" : apellido.Trim()[0].ToString().ToUpper();
        return (a + b).Trim();
    }

    private static string RolLabel(RolEquipo rol) => rol switch
    {
        RolEquipo.Rector => "Rector/a",
        RolEquipo.PenaYComunicacion => "PeÃ±a/Comu",
        RolEquipo.Infraestructura => "Infra",
        RolEquipo.ViaCrucis => "VÃ­a Crucis",
        RolEquipo.Espiritualidad => "Espiritualidad",
        RolEquipo.Coro => "Coro",
        RolEquipo.Apostolado => "Apostolado",
        RolEquipo.Asesor => "Asesor",
        RolEquipo.Asesora => "Asesora",
        _ => rol.ToString()
    };

    private record GroupVM(string Area, string Descripcion, List<TeamMember> Miembros);
}
